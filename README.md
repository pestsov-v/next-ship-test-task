# NextShip тестове завдання

Завдання в собі включає архітектурні рішення, а також реалізації безпосередніх тестових задач

## Зміст
- Зміст тестового завдання
- Архітектура застосунку
- Концепції
- Результати вирішення задач

## Зміст тестового завдання

## Завдання 1

Завдання: імпортувати файл дампа в БД.

###Формат файлу

Формат звичайного тексту, що представляє об’єкти з властивостями та іншими вкладеними об’єктами
об'єктів. Ієрархія визначається відступами (кожен рівень 2 проміжки).
Тип кожного об'єкта називається з великої літери, властивості - з а
маленька літера. Файл містить список співробітників (Employee), кожен з основними
властивості (ім'я, прізвище, ідентифікатор). Крім того, кожен співробітник належить до деяких
відділу (Відділу) і має розписку посадових окладів (Відомість) за рік.
Зарплата визначається датою і сумою (завжди в доларах США). Працівник може
також є записи про благодійні внески (пожертви), внески
сума може бути в будь-якій валюті. Крім того, файл містить обмін
курси (Rate) для всіх пар дата-валюта, які зустрічалися в
внески. Досить зберігати еквівалент внесків у доларах США
в базі даних.
Файл дампа додається.

## Завдання 2 (запит)

Мета: створити кінцеву точку API, яка виконує такі обчислення
в БД і повертає результати. Необхідно виконати всі розрахунки
в одному запиті SQL.

Для співробітників, які пожертвували понад 100 доларів на благодійність, розрахуйте одноразово
винагорода, еквівалентна їх внеску з пулу в 10 000 доларів США.
Наприклад, якщо працівник надіслав 200 доларів США із загальної суми 1000 доларів США,
він/вона має отримати 20% від 10 000 доларів США.
Якщо внески працівника становлять менше 100 доларів США, вартість слід врахувати
до загальної суми, але працівник не отримує винагороди.

### Питання

Мета: продемонструвати, що прийняті вами дизайнерські рішення були надійними
відповідаючи на питання.

1. Як змінити код для підтримки різних версій файлів?
2. Як зміниться система імпорту, якщо зникнуть дані про курси валют
   файл, і його потрібно буде отримати асинхронно (через API)?
3. У майбутньому клієнт може забажати імпортувати файли через веб-інтерфейс,
   як можна змінити систему, щоб це дозволило?

## Архітектура застосунку


## Концепції


## Результати вирішення задач

### Завдання 1

- Ядро сервера має окремий єндпоїнт `/v1/streams` через, який необхідно завантажувати файли на сервер. 
  - З урахуванням конфігурації файл тимчасово зберігається в необхідному варіанта - в пам'яті, в тимчасову файлі і т.д.
  - Файл підтримує обробку декількох файлів.
  - Це необхідно для препроцессінга, в подальшому перевірки прав доступу, перевірки ліміту чи кількості запитів від тієї чи іншої сессії, обмеження в рамках конкретної сессії і т.д

![img_1.png](img_1.png)

- Після чого необхідно здійснити запит до `/v1/call/api/ShipNext/ShipAccounting/v1/set-employee-accounts` та передати унікальний ідентифікатор streamId - тимчасового файлу.

![img_2.png](img_2.png)

### Завдання 

Необхідно здійснити виклик маршруту `/v1/call/api/ShipNext/ShipEmployee/v1/calculate-employee-remuneration`. Результатом виконання є массив об'єктів:
```json5
{
  "status": "success",
  "data": {
    "remunerations": [
      {
        "totalDonationAmountAll": 28206.07878,
        "totalDonationAmount": 310.52318,
        "rewardPercentage": 0.011009087169542395,
        "totalDonationPool": 10000,
        "rewardAmount": 110.09087169542394,
        "employeeName": "Jensen",
        "employeeSurname": "Wuckert"
      },
      {
        "totalDonationAmountAll": 28206.07878,
        "totalDonationAmount": 242.88144,
        "rewardPercentage": 0.008610960846220823,
        "totalDonationPool": 10000,
        "rewardAmount": 86.10960846220823,
        "employeeName": "Dangelo",
        "employeeSurname": "Larkin"
      },
      {
        "totalDonationAmountAll": 28206.07878,
        "totalDonationAmount": 132.44,
        "rewardPercentage": 0.004695441753282943,
        "totalDonationPool": 10000,
        "rewardAmount": 46.95441753282943,
        "employeeName": "Dangelo",
        "employeeSurname": "Larkin"
      },
      {
        "totalDonationAmountAll": 28206.07878,
        "totalDonationAmount": 208.12,
        "rewardPercentage": 0.007378551326587482,
        "totalDonationPool": 10000,
        "rewardAmount": 73.78551326587481,
        "employeeName": "Dangelo",
        "employeeSurname": "Larkin"
      },
      // ...
    ]
  }
}
```
де:
- `totalDonationAmountAll` - суммарні пожертувавання співробітниками.
- `totalDonationAmount` - сума пожертувавнь конкретним співробітником.
- `rewardPercentage` - відсоток пожертувавнь конкретним працівником відносно `totalDonationAmountAll`
- `totalDonationPool` - загальний пул виногороди.
- `rewardAmount` - винагорода конкретного співпрацівника.
- `employeeName` - ім'я працівника.
- `employeeSurname` - прізвище працівника.


![img.png](img.png)

### Відповіді на запитання

1. Як змінити код для підтримки різних версій файлів?
    Ядро сервера не зміниться ніяк не зміниться. В Схемі застосунків в залежності від бізнес-вимог будуть наступні сценарії:
   - в системі в колекції "ShipAccounting" буде замінений обробник маршруту в документі Controller, в разі зміни структури бази даних, додатково пишеться міграція бази даних.
   - Створення нового маршруту з новою версією (ядро сервера вимагається вказувати версію маршруту), та в документі helpers відповідної категорії написаний метод `transform`, який переводить з старого формату (для підтримки версії v1 в новий формат).

2. Як зміниться система імпорту, якщо зникнуть дані про курси валют файл, і його потрібно буде отримати асинхронно (через API)?
    - В `helpers` колекції `ShipAccounting` потрібно створити додаткову перевірку при `Split` файлу по ключовому слову `Rates`. Якщо елемент один (за відсутності `Rates`) - необхідно викликати додатковий helper -  `getRatesForHTTP`, в якому відбувається асихнронний запит до відповідної інтеграції.
В подальшому, в залежності від бізнес-вимог, потрібно зберігати курс або в базі даних або в кеш сервісі, або здійснювати постійно запит до інтеграції - власника інформації.
3. В майбутньому клієнт може забажати імпортувати файли через веб-інтерфейс, як можна змінити систему, щоб це дозволило?
    - Ніяк, логіка побудова с самого початку таким чином, щоб файл завантажувався через API.

